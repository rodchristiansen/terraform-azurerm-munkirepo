trigger:
  branches:
    include: [main]
  paths:
    include:
      - '*.tf'
      - 'modules/*'

pool:
  vmImage: ubuntu-latest

variables:
  - group: repo-secrets  # Azure Key Vault-backed library
  - name: terraformVersion
    value: '1.7.x'
  - name: azureServiceConnection
    value: 'AZURE-SERVICE-CONNECTION'

stages:
  # ───────────────────── Terraform ─────────────────────
  - stage: TerraformInfra
    displayName: 'Deploy Infrastructure'
    jobs:
      - job: Terraform
        displayName: 'Terraform Apply'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '$(terraformVersion)'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: azurerm
              command: init
              backendServiceArm: '$(azureServiceConnection)'
              backendAzureRmResourceGroupName: 'Terraform'
              backendAzureRmStorageAccountName: 'tfstate'
              backendAzureRmContainerName: 'state'
              backendAzureRmKey: 'munki.tfstate'
              workingDirectory: '$(System.DefaultWorkingDirectory)'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            name: plan
            inputs:
              provider: azurerm
              command: plan
              environmentServiceNameAzureRM: '$(azureServiceConnection)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
              commandOptions: |
                -lock=true
                -lock-timeout=300s
                -var="azure_tenant_id=$(AzureTenantId)"
                -var="devops_group_object_id=$(DevopsGroupObjectId)"
                -var="munki_username=$(MunkiUsername)"
                -var="munki_password=$(MunkiPassword)"
                -var="munki_client_token=$(MunkiClientToken)"
                -out=tfplan

          - bash: |
              if [ -s tfplan ]; then
                echo "##vso[task.setvariable variable=TerraformHasChanges]true"
              else
                echo "##vso[task.setvariable variable=TerraformHasChanges]false"
              fi
            workingDirectory: '$(System.DefaultWorkingDirectory)'
            displayName: 'Detect Changes'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            condition: eq(variables['TerraformHasChanges'], 'true')
            inputs:
              provider: azurerm
              command: apply
              environmentServiceNameAzureRM: '$(azureServiceConnection)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'
              commandOptions: '-auto-approve tfplan'
